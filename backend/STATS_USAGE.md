# ç»Ÿè®¡åŠŸèƒ½ä½¿ç”¨è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

ç»Ÿè®¡ç³»ç»Ÿæ”¯æŒè®°å½•å’ŒæŸ¥è¯¢ç”¨æˆ·ä½¿ç”¨æ•°æ®ï¼ŒåŒ…æ‹¬ï¼š
- **UV (Unique Visitors)**: ç‹¬ç«‹è®¾å¤‡/ç”¨æˆ·æ•°
- **PV (Page Views)**: æ€»ä½¿ç”¨æ¬¡æ•°
- **æ—¶é—´ç»´åº¦**: æ”¯æŒæŒ‰æ—¥ã€å‘¨ã€æœˆæ±‡æ€»

## æ•°æ®å­˜å‚¨

- **Redis å­˜å‚¨ç»“æ„**:
  - `usage:unique_devices:v1` - ç´¯è®¡ç‹¬ç«‹è®¾å¤‡é›†åˆ
  - `stats:daily:{YYYY-MM-DD}:devices` - æ¯æ—¥ç‹¬ç«‹è®¾å¤‡é›†åˆ
  - `stats:daily:{YYYY-MM-DD}:count` - æ¯æ—¥ä½¿ç”¨æ¬¡æ•°
- **æ•°æ®ä¿ç•™**: æ¯æ—¥ç»Ÿè®¡ä¿ç•™ 365 å¤©
- **è‡ªåŠ¨è®°å½•**: æ¯æ¬¡ç”Ÿæˆè¡¨æƒ…åŒ…æ—¶è‡ªåŠ¨è®°å½•

## API æ¥å£

### 1. è·å–ç´¯è®¡ç‹¬ç«‹ç”¨æˆ·æ•°

```bash
GET /api/admin/usage
Header: x-admin-token: <ADMIN_TOKEN>
```

**å“åº”**:
```json
{
  "code": 0,
  "data": {
    "uniqueDevices": 11
  }
}
```

### 2. è·å–è¯¦ç»†ç»Ÿè®¡æŠ¥è¡¨

```bash
GET /api/admin/stats?period=day&start=2025-12-01&end=2025-12-31
Header: x-admin-token: <ADMIN_TOKEN>
```

**å‚æ•°**:
- `period`: ç»Ÿè®¡å‘¨æœŸ
  - `day` - æŒ‰æ—¥ç»Ÿè®¡ï¼ˆé»˜è®¤ï¼‰
  - `week` - æŒ‰å‘¨æ±‡æ€»
  - `month` - æŒ‰æœˆæ±‡æ€»
- `start`: å¼€å§‹æ—¥æœŸ YYYY-MM-DDï¼ˆé»˜è®¤ï¼š30å¤©å‰ï¼‰
- `end`: ç»“æŸæ—¥æœŸ YYYY-MM-DDï¼ˆé»˜è®¤ï¼šä»Šå¤©ï¼‰

**å“åº”**:
```json
{
  "code": 0,
  "data": {
    "period": "day",
    "start": "2025-12-22",
    "end": "2025-12-29",
    "stats": [
      {
        "date": "2025-12-28",
        "uv": 10,
        "pv": 3
      },
      {
        "date": "2025-12-29",
        "uv": 1,
        "pv": 0
      }
    ]
  }
}
```

## å‘½ä»¤è¡Œå·¥å…·

### 1. æŸ¥çœ‹ç»Ÿè®¡æŠ¥è¡¨

```bash
# æŸ¥çœ‹æœ€è¿‘ 7 å¤©çš„æ—¥ç»Ÿè®¡
node view-stats.mjs day 7

# æŸ¥çœ‹æœ€è¿‘ 30 å¤©çš„å‘¨æ±‡æ€»
node view-stats.mjs week 30

# æŸ¥çœ‹æœ€è¿‘ 90 å¤©çš„æœˆæ±‡æ€»
node view-stats.mjs month 90
```

**è¾“å‡ºç¤ºä¾‹**:
```
ğŸ“Š ä½¿ç”¨ç»Ÿè®¡æŠ¥è¡¨
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æ—¶é—´èŒƒå›´: 2025-12-22 è‡³ 2025-12-29
ç»Ÿè®¡å‘¨æœŸ: æŒ‰æ—¥
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

æ—¥æœŸ              | ç‹¬ç«‹ç”¨æˆ·(UV)        | ä½¿ç”¨æ¬¡æ•°(PV)
------------------------------------------------------------
2025-12-28      | 10              | 3
2025-12-29      | 1               | 0
------------------------------------------------------------
åˆè®¡              | 11              | 3
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“ˆ ç´¯è®¡ç‹¬ç«‹ç”¨æˆ·æ•°: 11
```

### 2. ç»Ÿè®¡å†å²ä½¿ç”¨è®°å½•ï¼ˆæŒ‰æ—¥ï¼šäººæ•°/æ¬¡æ•°ï¼‰

é»˜è®¤ä»ç»Ÿè®¡ç³»ç»Ÿçš„ Redis Keyï¼ˆ`stats:daily:{date}:devices/count`ï¼Œä¿ç•™ 365 å¤©ï¼‰æŒ‰æ—¥æ±‡æ€»æŸ¥çœ‹ï¼š

```bash
# å¯é€‰ï¼šåœ¨ backend/.env é…ç½® REDIS_URL
# å¯é€‰ï¼šç”¨å‚æ•°é™åˆ¶æ—¥æœŸèŒƒå›´
node stats-historical-daily.mjs --start=2025-12-01 --end=2025-12-31
```

è¾“å‡ºæ ¼å¼ä¸ºä¸‰åˆ—ï¼š`æ—¥ äººæ•° æ¬¡æ•°`ï¼ˆäººæ•°=å½“æ—¥å»é‡è®¾å¤‡æ•°ï¼Œæ¬¡æ•°=å½“æ—¥ä½¿ç”¨æ¬¡æ•°åˆè®¡ï¼‰ã€‚

å¦‚æœä½ è¦ä» `free_quota:*` åæ¨ï¼ˆæ³¨æ„ï¼šè¯¥ç±» key é»˜è®¤ TTL çº¦ 24 å°æ—¶ï¼Œé€šå¸¸æ— æ³•è¦†ç›–æ›´ä¹…å†å²ï¼‰ï¼Œå¯æŒ‡å®šï¼š

```bash
node stats-historical-daily.mjs --source=free_quota --start=2025-12-01 --end=2025-12-31
```

### 3. æ¢å¤å†å²æ•°æ®

é¦–æ¬¡éƒ¨ç½²æˆ–æ•°æ®è¿ç§»æ—¶ä½¿ç”¨ï¼š

```bash
node restore-daily-stats.mjs
```

æ­¤è„šæœ¬ä¼šä» `free_quota:*` è®°å½•ä¸­æå–å†å²æ•°æ®å¹¶æ¢å¤åˆ°æ¯æ—¥ç»Ÿè®¡ä¸­ã€‚

## éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

1. **ç¡®ä¿é…ç½®äº† REDIS_URL**

åœ¨ `.env` æ–‡ä»¶ä¸­ï¼š
```env
REDIS_URL=redis://default:password@host:port
ADMIN_TOKEN=your-secure-random-token
```

2. **è¿è¡Œå†å²æ•°æ®æ¢å¤**ï¼ˆä»…é¦–æ¬¡ï¼‰

```bash
node restore-daily-stats.mjs
```

3. **é‡å¯åç«¯æœåŠ¡**

ç¡®ä¿æ–°ä»£ç ç”Ÿæ•ˆï¼š
```bash
npm run build
npm start
```

4. **éªŒè¯ç»Ÿè®¡åŠŸèƒ½**

```bash
curl -H "x-admin-token: YOUR_TOKEN" https://your-domain.com/api/admin/usage
```

## æ³¨æ„äº‹é¡¹

- ğŸ“Š **å‘¨/æœˆæ±‡æ€»çš„ UV**: å½“å‰æŒ‰å‘¨/æœˆæ±‡æ€»æ—¶ï¼ŒUV ä¸ºå„å¤© UV ä¹‹å’Œï¼Œä¸æ˜¯çœŸæ­£çš„å»é‡ç‹¬ç«‹ç”¨æˆ·æ•°ã€‚è¦å®ç°ç²¾ç¡®å»é‡éœ€è¦é¢å¤–çš„å®ç°ã€‚
- ğŸ”’ **å®‰å…¨æ€§**: æ‰€æœ‰ç»Ÿè®¡æ¥å£éƒ½éœ€è¦ `ADMIN_TOKEN` è®¤è¯ï¼Œè¯·å¦¥å–„ä¿ç®¡ã€‚
- ğŸ’¾ **æ•°æ®ä¿ç•™**: æ¯æ—¥ç»Ÿè®¡æ•°æ®åœ¨ Redis ä¸­ä¿ç•™ 365 å¤©ã€‚
- âš¡ **æ€§èƒ½**: ä½¿ç”¨ Redis æ‰¹é‡æ“ä½œï¼Œæ€§èƒ½è‰¯å¥½ï¼Œé€‚åˆå¤§è§„æ¨¡æ•°æ®ã€‚

## æœªæ¥æ”¹è¿›

- [ ] å®ç°å‘¨/æœˆç»´åº¦çš„ç²¾ç¡® UV å»é‡
- [ ] æ·»åŠ æ›´å¤šç»´åº¦ç»Ÿè®¡ï¼ˆåœ°åŸŸã€è®¾å¤‡ç±»å‹ç­‰ï¼‰
- [ ] æ•°æ®å¯è§†åŒ–å›¾è¡¨
- [ ] å¯¼å‡ºä¸º CSV/Excel
