# 表情包生成器 - 迭代需求文档 v2.0

## 📋 项目概述

**项目名称**：表情包生成器支持宠物
**当前版本**：v1.0
**目标版本**：v2.0
**迭代日期**：2025-12-16
**技术栈**：React 19 + Vite + TypeScript + Node.js + Express + Gemini AI

---

## 🎯 本次迭代目标

本次迭代主要围绕**用户体验优化**和**商业化准备**，新增以下核心功能：

1. ✅ 优化生成张数选择(去掉1张,保留4/8/12张)
2. ✅ 新增四格漫画模式(连续动作分解)
3. ✅ 优化表情选择逻辑(普通模式随机展示,四格漫画模式手动选择)
4. ✅ 后端服务改造(Node.js + Express)
5. ✅ 按次付费系统(4格¥1, 8格¥2, 12格¥3)
6. ✅ 保持现有页面风格一致性
7. ✅ 域名与部署发布配置(自有域名 + Cloudflare中转)

---

## 📝 详细需求说明

### 需求1：优化生成张数选择

**需求描述**
去掉"生成1张"的选项，仅保留 **4张 / 8张 / 12张** 三个选项。

**原因**
- 当前生成逻辑基于2x2网格(一次生成4张),去掉1张可保持技术实现的一致性
- 4张是最小单位,符合表情包的常见使用场景

**UI改动**
```
当前：[ 4张 ] [ 8张 ] [ 12张 ]  ← 按钮组
改为：[ 4张 ] [ 8张 ] [ 12张 ]  ← 无变化,仅去掉"1张"选项(如果之前有的话)
```

**影响文件**
- `App.tsx` - 生成张数选择逻辑
- 相关状态变量和UI组件

---

### 需求2：新增四格漫画模式(连续动作分解)

**需求描述**
在选择完风格后,新增一个"四格漫画模式"的开关选项。

**功能特性**

#### 2.1 普通模式(默认)
- **去掉表情选择区域**,改为**随机展示**
- 保留现有的 **[换一换/换一组]** 功能
- 每次点击"换一换",随机刷新一组表情(根据选择的张数:4/8/12个)
- 生成的表情包是**不同的动作/表情**

**示例**:
```
用户选择: 4张 + 普通模式 + 女性分类 + 日漫风格
点击"开始生成"
  ↓
后端随机抽取4个表情(从50个女性表情中随机)
  → 例如: 喝奶茶、减肥失败、买买买、化妆
  ↓
生成4张不同表情
```

#### 2.2 四格漫画模式(新增)
- **显示表情选择区域**,用户**手动选择1个表情**
- 提示文字:"请选择一个表情,将生成连续动作的4个阶段"
- 生成的4张表情是**同一个动作的连续分解**

**示例**:
```
用户选择: 4张 + 四格漫画模式 + 女性分类 + 日漫风格
点击表情选择区域,选择"微笑"
  ↓
生成4张连续动作:
  第1张: 准备微笑(嘴角微微上扬)
  第2张: 开始微笑(露出牙齿)
  第3张: 微笑高峰(眼睛眯起,笑容最灿烂)
  第4张: 微笑结束(恢复平静,嘴角仍带笑意)
```

**连续动作分解示例**

| 表情 | 第1阶段 | 第2阶段 | 第3阶段 | 第4阶段 |
|------|---------|---------|---------|---------|
| 微笑 | 准备微笑 | 开始微笑 | 微笑高峰 | 微笑结束 |
| 吃火锅 | 看到火锅眼睛发光 | 拿起筷子夹食材 | 大口吃火锅满足 | 吃完摸肚子心满意足 |
| 大哭 | 眼眶湿润开始委屈 | 眼泪流下表情难过 | 大声哭泣泪流满面 | 哭累了抽泣擦眼泪 |
| 加班 | 看到加班通知震惊 | 无奈打开电脑 | 疲惫工作打哈欠 | 终于下班松口气 |

**实现逻辑**

```typescript
// Prompt生成策略
if (isComicMode) {
  // 四格漫画模式:基于用户选择的1个表情,生成4个连续阶段
  const baseEmotion = userSelectedEmotion; // 例如"微笑"

  const prompts = generateComicStages(baseEmotion);
  // 返回: ["准备微笑...", "开始微笑...", "微笑高峰...", "微笑结束..."]
} else {
  // 普通模式:从当前分类的表情库中随机抽取
  const allEmotions = EMOTIONS[currentCategory]; // 例如 female的50个表情
  const prompts = randomSample(allEmotions, selectedCount); // 随机抽4/8/12个
}
```

**UI设计**

```
┌─────────────────────────────────────┐
│ 选择风格                             │
│ [波普艺术] [日漫] [3D萌趣] ...       │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│ ☐ 四格漫画模式                       │  ← 新增开关
│ 生成连续动作的四格漫画效果           │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│ 【情况1:四格漫画模式关闭(默认)】     │
│  (表情选择区域隐藏)                  │
│  系统将随机为你选择表情              │
│  [换一换] 按钮 ← 点击刷新随机表情     │
└─────────────────────────────────────┘

或

┌─────────────────────────────────────┐
│ 【情况2:四格漫画模式开启】           │
│  请选择一个表情,生成连续动作的4个阶段│
│  [微笑] [大哭] [震惊] [比心] ...     │  ← 显示表情选择
└─────────────────────────────────────┘
```

**交互逻辑**

- 当用户**关闭四格漫画模式(默认)**时:
  - **隐藏表情选择区域**
  - 显示提示文字:"系统将随机为你选择表情"
  - 显示 **[换一换]** 按钮,点击后随机刷新一组表情
  - 点击"开始生成"时,从表情库随机抽取对应数量的表情

- 当用户**开启四格漫画模式**时:
  - **显示表情选择区域**
  - 提示文字:"请选择一个表情,将生成连续动作的4个阶段"
  - 用户**必须选择1个表情**,否则"开始生成"按钮禁用
  - 隐藏 **[换一换]** 按钮(因为用户手动选择)

**生成数量限制**

- 四格漫画模式:**仅支持4张生成**(因为4张才是完整的漫画)
- 如果用户选择8张或12张,四格漫画开关自动**禁用或变灰**

**影响文件**
- `App.tsx` - 新增四格漫画模式状态和逻辑
- `services/geminiService.ts` - 调整Prompt生成策略
- `constants.ts` - 新增连续动作Prompt生成函数

---

### 需求3：后端服务改造

**需求描述**
将API调用从前端迁移到后端,搭建 **Node.js + Express** 服务,实现以下功能:
1. 代理Gemini API调用(隐藏API密钥)
2. 处理付费逻辑(按次计费)
3. 为后续功能预留接口

**技术栈**
- **后端框架**:Node.js + Express + TypeScript
- **数据库**:Redis(用于缓存订单和支付状态,快速读写)
- **部署平台**:Vercel / Railway / Render(支持免费额度,快速部署)

**后端架构设计**

```
前端 (React)
    ↓
后端 API (Express)
    ├─ /api/analyze-character (角色分析)
    ├─ /api/generate-sticker-grid (生成2x2网格)
    ├─ /api/payment/create (创建支付订单)
    └─ /api/payment/verify (验证支付状态)
    ↓
Gemini AI (Google)
```

**API接口设计**

#### 3.1 角色分析(Step 1)
```http
POST /api/analyze-character
Body:
{
  "referenceImage": "data:image/png;base64,...",
  "category": "female"
}

Response:
{
  "success": true,
  "data": {
    "characterDNA": "A young woman with long black hair..."
  }
}
```

#### 3.2 生成表情网格(Step 2)
```http
POST /api/generate-sticker-grid
Headers:
  X-Payment-Token: <支付凭证>  ← 验证用户是否已付费
Body:
{
  "characterDNA": "A young woman...",
  "prompts": ["微笑", "大哭", "震惊", "比心"],
  "style": "manga",
  "referenceImage": "data:image/png;base64,...",
  "isSlave": false
}

Response:
{
  "success": true,
  "data": {
    "gridImage": "data:image/png;base64,..."
  }
}

Error Response (未付费):
{
  "success": false,
  "error": "PAYMENT_REQUIRED",
  "message": "请先完成支付",
  "data": {
    "paymentUrl": "/payment?count=4"
  }
}
```

#### 3.3 创建支付订单
```http
POST /api/payment/create
Body:
{
  "count": 4,  // 生成张数: 4/8/12
  "userId": "192.168.1.1_abc123"  // 用户标识(IP + Device ID)
}

Response:
{
  "success": true,
  "data": {
    "orderId": "order_12345",
    "amount": 1.00,  // 金额(元): 4张¥1, 8张¥2, 12张¥3
    "paymentUrl": "https://payment.example.com/xxx",  // 支付页面URL
    "paymentToken": "token_abc123",  // 支付凭证(前端需保存)
    "expiresAt": "2025-12-16T11:00:00Z"  // 订单过期时间(15分钟)
  }
}
```

#### 3.4 验证支付状态
```http
GET /api/payment/verify?orderId=order_12345

Response (已支付):
{
  "success": true,
  "data": {
    "status": "paid",
    "paymentToken": "token_abc123",
    "count": 4,
    "paidAt": "2025-12-16T10:45:00Z"
  }
}

Response (未支付):
{
  "success": true,
  "data": {
    "status": "pending",
    "orderId": "order_12345"
  }
}
```

**用户识别方案**

##### Web端(当前)
```typescript
// 前端生成设备ID(首次访问时生成,存储在localStorage)
const deviceId = localStorage.getItem('deviceId') || generateUUID();
localStorage.setItem('deviceId', deviceId);

// 后端识别逻辑(IP + Device ID 组合)
const userId = `${req.ip}_${req.headers['x-device-id']}`;
```

##### 微信小程序端(未来扩展)
```typescript
// 前端获取OpenID
wx.login({
  success: (res) => {
    // 发送code到后端,换取openid
    fetch('/api/wechat/login', {
      body: { code: res.code }
    });
  }
});

// 后端使用OpenID作为用户ID
const userId = openid; // 微信用户唯一标识
```

**影响文件(新增)**
```
backend/
├── src/
│   ├── index.ts           # Express入口
│   ├── routes/
│   │   ├── character.ts   # 角色分析路由
│   │   ├── sticker.ts     # 表情生成路由
│   │   └── payment.ts     # 支付路由
│   ├── services/
│   │   ├── gemini.ts      # Gemini API调用
│   │   └── payment.ts     # 支付逻辑
│   ├── middleware/
│   │   ├── auth.ts        # 用户识别中间件
│   │   └── rateLimit.ts   # 速率限制
│   └── utils/
│       ├── redis.ts       # Redis客户端
│       └── logger.ts      # 日志工具
├── package.json
└── tsconfig.json
```

**前端改动**
- 移除前端的 `geminiService.ts` 中的直接API调用
- 改为调用后端API(`/api/*`)
- 新增支付流程处理

---

### 需求4：按次付费系统

**需求描述**
实现按次付费模式,用户需要先付费才能生成表情包。

**付费标准**
- **4张**: ¥1.00
- **8张**: ¥2.00
- **12张**: ¥3.00

**核心逻辑**
1. 用户上传参考图,选择张数、风格等
2. 点击"开始生成"按钮
3. **先跳转到支付页面**,完成支付
4. 支付成功后,自动开始生成表情包
5. 生成完成后,用户可下载

**UI设计**

#### 4.1 生成按钮(显示价格)

```tsx
// 根据选择的张数显示价格
<button onClick={handleGenerate}>
  {selectedCount === 4 && "开始生成 (¥1.00)"}
  {selectedCount === 8 && "开始生成 (¥2.00)"}
  {selectedCount === 12 && "开始生成 (¥3.00)"}
</button>
```

#### 4.2 支付流程

```
用户点击"开始生成(¥1.00)"
    ↓
显示支付二维码/跳转支付页面
┌─────────────────────────────────────┐
│            扫码支付                  │
│                                      │
│      [微信支付二维码]                │
│                                      │
│      支付金额: ¥1.00                 │
│      订单号: order_12345             │
│                                      │
│      [取消支付]                      │
└─────────────────────────────────────┘
    ↓
用户扫码支付
    ↓
支付成功
┌─────────────────────────────────────┐
│         ✅ 支付成功!                 │
│                                      │
│   正在为你生成表情包,请稍候...       │
│   [进度条: 25%]                      │
└─────────────────────────────────────┘
    ↓
生成完成,显示表情包
```

#### 4.3 支付失败/取消

```
┌─────────────────────────────────────┐
│         ❌ 支付失败                  │
│                                      │
│   支付未完成或已取消                 │
│   [重新支付]  [返回首页]            │
└─────────────────────────────────────┘
```

**生成流程**

```
用户点击"开始生成"
    ↓
前端调用 POST /api/payment/create
    ↓
后端创建支付订单
    └─ 生成订单ID、支付URL、支付Token
    └─ 存储到Redis(15分钟过期)
    ↓
前端显示支付页面(二维码/跳转链接)
    ↓
用户完成支付(微信/支付宝)
    ↓
支付平台回调后端 POST /api/payment/callback
    ↓
后端更新订单状态为"已支付"
    └─ 更新Redis: status = "paid"
    ↓
前端轮询 GET /api/payment/verify?orderId=xxx
    └─ 每2秒查询一次,最多查询30次(60秒)
    ↓
支付状态变为"paid"
    ↓
前端获取 paymentToken,开始生成表情包
    ├─ POST /api/analyze-character
    ├─ POST /api/generate-sticker-grid (Headers: X-Payment-Token)
    └─ 后端验证Token有效性,允许生成
    ↓
生成完成,展示表情包
```

**Redis数据结构**

```typescript
// Key: payment:{orderId}
// Value: JSON字符串
interface PaymentOrder {
  orderId: string;
  userId: string;         // IP + Device ID
  count: number;          // 生成张数: 4/8/12
  amount: number;         // 金额(元): 1/2/3
  status: "pending" | "paid" | "expired";
  paymentToken: string;   // 支付凭证(生成表情包时验证)
  createdAt: string;
  paidAt?: string;
  expiresAt: string;      // 订单过期时间(15分钟)
}

// 示例
// Key: payment:order_12345
// Value:
{
  "orderId": "order_12345",
  "userId": "192.168.1.1_abc123",
  "count": 4,
  "amount": 1.00,
  "status": "paid",
  "paymentToken": "token_abc123",
  "createdAt": "2025-12-16T10:30:00Z",
  "paidAt": "2025-12-16T10:32:15Z",
  "expiresAt": "2025-12-16T10:45:00Z"
}
```

**支付平台选择(建议)**

| 平台 | 适用场景 | 费率 | 集成难度 |
|------|----------|------|----------|
| **微信支付** | Web端、微信小程序 | 0.6% | ⭐⭐⭐ |
| **支付宝** | Web端 | 0.6% | ⭐⭐⭐ |
| **Stripe** | 国际化支付(信用卡) | 2.9% + ¥2 | ⭐⭐⭐⭐ |
| **PayPal** | 国际化支付 | 3.4% + ¥2.35 | ⭐⭐⭐ |

**推荐**: Web端使用**微信支付 + 支付宝**双通道,微信小程序端使用**微信支付**。

**防刷机制**

1. **订单过期时间**: 15分钟未支付自动取消
2. **支付Token一次性**: 每个Token仅允许生成1次,生成后失效
3. **速率限制**: 单IP每分钟最多创建5个订单
4. **异常监控**: 同一IP短时间大量创建订单,自动封禁

**影响文件**
- `App.tsx` - 新增支付流程逻辑
- `backend/src/routes/payment.ts` - 支付路由
- `backend/src/services/payment.ts` - 支付逻辑

---

### 需求5：保持页面风格一致性

**需求描述**
所有新增功能的UI设计必须与现有页面风格保持一致。

**设计规范**
1. **色彩系统**:
   - 主色调:Tailwind默认蓝色(`bg-blue-500`)
   - 成功:绿色(`bg-green-500`)
   - 警告:黄色/橙色(`bg-yellow-500` / `bg-orange-500`)
   - 错误:红色(`bg-red-500`)
   - 背景:白色/浅灰(`bg-white` / `bg-gray-50`)

2. **字体**:
   - 默认:`font-sans`(系统字体)
   - 标题:`text-2xl font-bold`
   - 正文:`text-base`

3. **圆角**:
   - 按钮:`rounded-lg`
   - 卡片:`rounded-xl`
   - 输入框:`rounded-md`

4. **阴影**:
   - 卡片:`shadow-lg`
   - 按钮悬停:`hover:shadow-xl`

5. **间距**:
   - 外边距:`m-4` / `my-6`
   - 内边距:`p-4` / `px-6 py-3`

6. **动画**:
   - 过渡:`transition-all duration-300`
   - 悬停效果:`hover:scale-105`

**示例代码**

```tsx
// 四格漫画开关(与现有风格一致)
<div className="bg-white rounded-xl shadow-lg p-6 my-4">
  <label className="flex items-center space-x-3 cursor-pointer">
    <input
      type="checkbox"
      checked={isComicMode}
      onChange={(e) => setIsComicMode(e.target.checked)}
      className="w-5 h-5 text-blue-500 rounded focus:ring-2 focus:ring-blue-300"
    />
    <div>
      <span className="text-lg font-semibold">四格漫画模式</span>
      <p className="text-sm text-gray-500">生成连续动作的四格漫画效果</p>
    </div>
  </label>
</div>

// 支付按钮(显示价格)
<button
  onClick={handleGenerate}
  className="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transition-all duration-300"
>
  {selectedCount === 4 && "开始生成 (¥1.00)"}
  {selectedCount === 8 && "开始生成 (¥2.00)"}
  {selectedCount === 12 && "开始生成 (¥3.00)"}
</button>
```

**影响文件**
- 所有新增的UI组件

---

### 需求6：域名与部署发布配置

**需求描述**
使用自有域名，通过Cloudflare进行CDN加速和安全防护，完成前后端的生产环境部署。

**域名规划**

假设你的自有域名是 `example.com`，建议以下域名分配方案：

| 服务 | 域名 | 用途 |
|------|------|------|
| 前端(Web) | `sticker.example.com` 或 `www.example.com` | 用户访问的主站 |
| 后端API | `api.example.com` | 后端API接口 |
| 静态资源(可选) | `cdn.example.com` | 图片、JS、CSS等静态资源 |

---

#### 6.1 Cloudflare配置

**为什么选择Cloudflare？**
- ✅ 免费的全球CDN加速
- ✅ 免费的SSL证书（自动续期）
- ✅ DDoS防护和WAF（Web应用防火墙）
- ✅ 页面缓存规则（加快访问速度）
- ✅ 支持API请求速率限制

**配置步骤**

##### Step 1: 添加域名到Cloudflare

1. 登录 [Cloudflare控制台](https://dash.cloudflare.com/)
2. 点击"添加站点"，输入你的域名 `example.com`
3. 选择Free计划（免费）
4. Cloudflare会扫描你的DNS记录

##### Step 2: 配置DNS记录

在Cloudflare DNS管理页面，添加以下记录：

```
类型    名称              内容                          代理状态      TTL
────────────────────────────────────────────────────────────────────
A       sticker          <前端部署IP>                  已代理(橙色云) Auto
CNAME   sticker          <Vercel分配的域名>            已代理(橙色云) Auto
A       api              <后端部署IP>                  已代理(橙色云) Auto
CNAME   api              <Railway分配的域名>           已代理(橙色云) Auto
```

**说明**：
- **已代理(橙色云)**：流量经过Cloudflare，享受CDN和安全防护
- **仅DNS(灰色云)**：流量直达源服务器，不经过Cloudflare
- 推荐：前端和后端都使用**已代理**模式

##### Step 3: 更新域名服务器(Nameservers)

Cloudflare会提供2个域名服务器地址，例如：
```
ns1.cloudflare.com
ns2.cloudflare.com
```

到你的域名注册商（如阿里云、腾讯云、GoDaddy等）修改域名的NS记录，指向Cloudflare的域名服务器。

**等待生效**：通常需要几分钟到24小时不等。

##### Step 4: 配置SSL/TLS加密

1. 进入 **SSL/TLS** → **概述**
2. 选择加密模式：**完全(严格)** (Full Strict)
   - 前端和后端都需要有有效的SSL证书
   - Vercel/Railway会自动提供免费SSL证书

3. 进入 **SSL/TLS** → **边缘证书**
4. 开启以下选项：
   - ✅ **始终使用HTTPS**（自动将HTTP重定向到HTTPS）
   - ✅ **自动HTTPS重写**
   - ✅ **最低TLS版本**：TLS 1.2

##### Step 5: 配置页面规则(Page Rules)

**前端缓存规则**（加速静态资源）

进入 **规则** → **页面规则**，创建以下规则：

```
规则1: 缓存静态资源
URL匹配: sticker.example.com/assets/*
设置:
  - 缓存级别: 缓存所有内容
  - 边缘缓存TTL: 1个月
  - 浏览器缓存TTL: 1天
```

```
规则2: API不缓存
URL匹配: api.example.com/*
设置:
  - 缓存级别: 绕过
```

##### Step 6: 配置防火墙规则(可选)

进入 **安全性** → **WAF**，创建以下规则：

```
规则1: 限制API请求频率
字段: 主机名
运算符: 等于
值: api.example.com
然后:
  - 速率限制: 每分钟100次请求(根据IP)
  - 超出后: 阻止10分钟
```

```
规则2: 阻止恶意User-Agent
字段: User-Agent
运算符: 包含
值: bot, crawler, scraper (恶意爬虫)
然后: 阻止
```

---

#### 6.2 前端部署(Vercel)

**为什么选择Vercel？**
- ✅ 专为React/Vite优化，零配置部署
- ✅ 免费SSL证书，自动续期
- ✅ 全球CDN，访问速度快
- ✅ 自动构建和部署（git push即部署）
- ✅ 免费额度充足（100GB流量/月）

**部署步骤**

##### Step 1: 安装Vercel CLI
```bash
npm install -g vercel
```

##### Step 2: 登录Vercel
```bash
vercel login
```

##### Step 3: 部署项目
```bash
# 在前端项目根目录执行
vercel

# 生产环境部署
vercel --prod
```

##### Step 4: 配置自定义域名

1. 进入 [Vercel控制台](https://vercel.com/dashboard)
2. 选择你的项目
3. 进入 **Settings** → **Domains**
4. 添加域名：`sticker.example.com`
5. Vercel会提供一个CNAME记录值，例如：`cname.vercel-dns.com`

回到Cloudflare DNS设置，添加记录：
```
类型    名称       内容                      代理状态
CNAME   sticker    cname.vercel-dns.com      已代理
```

##### Step 5: 配置环境变量

在Vercel控制台，进入 **Settings** → **Environment Variables**，添加：

```
VITE_API_URL = https://api.example.com
VITE_PAYMENT_CALLBACK_URL = https://sticker.example.com/payment/callback
```

##### Step 6: 重新部署
```bash
vercel --prod
```

---

#### 6.3 后端部署(Railway)

**为什么选择Railway？**
- ✅ 支持Node.js应用部署
- ✅ 内置Redis支持（免费5MB）
- ✅ 免费SSL证书
- ✅ 简单的环境变量管理
- ✅ 免费额度：$5/月（足够初期使用）

**部署步骤**

##### Step 1: 安装Railway CLI
```bash
npm install -g @railway/cli
```

##### Step 2: 登录Railway
```bash
railway login
```

##### Step 3: 初始化项目
```bash
# 在后端项目根目录执行
railway init
```

##### Step 4: 添加Redis服务

1. 进入 [Railway控制台](https://railway.app/dashboard)
2. 选择你的项目
3. 点击 **New** → **Database** → **Add Redis**
4. Railway会自动创建Redis实例，并提供连接URL

##### Step 5: 配置环境变量

在Railway控制台，进入 **Variables** 标签，添加：

```
NODE_ENV = production
PORT = 8080

# Gemini API
GEMINI_API_KEY = <你的Gemini API Key>

# Redis
REDIS_URL = <Railway自动生成的Redis URL>

# 微信支付
WECHAT_PAY_MERCHANT_ID = <商户号>
WECHAT_PAY_API_KEY = <API密钥>
WECHAT_PAY_CERT = <证书内容>

# CORS允许的域名
ALLOWED_ORIGINS = https://sticker.example.com

# 支付回调URL
PAYMENT_CALLBACK_URL = https://api.example.com/api/payment/callback
```

##### Step 6: 部署
```bash
railway up
```

##### Step 7: 配置自定义域名

1. 在Railway控制台，进入 **Settings** → **Domains**
2. 点击 **Generate Domain**，Railway会生成一个临时域名，如：`your-app.up.railway.app`
3. 点击 **Custom Domain**，输入：`api.example.com`

回到Cloudflare DNS设置，添加记录：
```
类型    名称    内容                           代理状态
CNAME   api     your-app.up.railway.app         已代理
```

---

#### 6.4 其他部署平台选择

如果Railway不满足需求，可以考虑以下平台：

| 平台 | 优势 | 劣势 | 免费额度 |
|------|------|------|----------|
| **Railway** | 简单易用，内置Redis | 免费额度较少($5/月) | $5/月 |
| **Render** | 免费额度多，支持PostgreSQL | 冷启动较慢（15秒） | 750小时/月 |
| **Fly.io** | 全球边缘部署，速度快 | 配置稍复杂 | 3个共享CPU实例 |
| **Heroku** | 老牌平台，生态成熟 | 免费计划已取消 | 无免费版 |
| **阿里云/腾讯云** | 国内速度快，稳定 | 需要备案，成本较高 | 新用户优惠 |

**推荐**：
- **前端**：Vercel（最优选择）
- **后端**：Railway（简单）或 Render（免费额度多）

---

#### 6.5 支付回调配置

**重要**：支付平台（微信支付/支付宝）的回调URL必须是**公网可访问的HTTPS地址**。

##### 微信支付配置

1. 登录 [微信支付商户平台](https://pay.weixin.qq.com/)
2. 进入 **产品中心** → **开发配置**
3. 设置支付回调URL：
   ```
   https://api.example.com/api/payment/callback
   ```
4. 配置授权目录（H5支付需要）：
   ```
   https://sticker.example.com/
   ```

##### 支付宝配置

1. 登录 [支付宝开放平台](https://open.alipay.com/)
2. 进入你的应用配置
3. 设置异步通知URL：
   ```
   https://api.example.com/api/payment/alipay-callback
   ```

---

#### 6.6 部署检查清单

部署完成后，请按以下清单逐项验证：

**前端检查**
- [ ] `https://sticker.example.com` 可正常访问
- [ ] SSL证书有效（浏览器地址栏显示🔒）
- [ ] 页面加载速度 < 3秒
- [ ] 静态资源（图片、JS、CSS）正常加载
- [ ] 移动端适配正常

**后端检查**
- [ ] `https://api.example.com/health` 返回200（健康检查）
- [ ] API响应时间 < 3秒
- [ ] CORS配置正确（前端可跨域调用API）
- [ ] Redis连接正常
- [ ] Gemini API调用正常
- [ ] 日志记录正常

**域名&SSL检查**
- [ ] Cloudflare代理状态为"已代理"（橙色云）
- [ ] 强制HTTPS已开启
- [ ] SSL证书有效期 > 30天
- [ ] DNS解析正确（`nslookup sticker.example.com`）

**支付功能检查**
- [ ] 支付回调URL可公网访问
- [ ] 微信支付回调验证签名正确
- [ ] 支付宝回调验证签名正确
- [ ] 订单创建正常
- [ ] 支付成功后生成流程正常

**性能&安全检查**
- [ ] Cloudflare缓存规则生效
- [ ] API速率限制正常工作
- [ ] 恶意请求被WAF拦截
- [ ] 并发10个用户测试无报错

---

#### 6.7 部署架构图

```
用户浏览器
    ↓
Cloudflare CDN (全球加速 + 安全防护)
    ├──> sticker.example.com (前端)
    │       ↓
    │    Vercel (React应用)
    │       ├─ 静态资源缓存(Cloudflare边缘节点)
    │       └─ HTML渲染
    │
    └──> api.example.com (后端)
            ↓
         Railway (Node.js + Express)
            ├─ Redis (订单缓存)
            ├─ Gemini API (生成表情包)
            └─ 微信支付/支付宝 (支付处理)
```

---

#### 6.8 监控与日志

**推荐监控工具**

1. **Cloudflare Analytics**（免费）
   - 查看流量、带宽、缓存命中率
   - 查看被拦截的恶意请求

2. **Vercel Analytics**（免费）
   - 查看页面访问量、加载速度
   - 查看用户地理分布

3. **Railway Logs**（免费）
   - 查看后端日志（console.log输出）
   - 查看API请求日志

4. **Sentry**（可选，免费额度5000错误/月）
   - 前后端错误监控
   - 实时报警（邮件/Slack）

**日志记录建议**

后端必须记录以下日志：
- ✅ 所有API请求（时间、路径、IP、响应状态）
- ✅ 支付订单创建（订单ID、金额、用户ID）
- ✅ 支付回调（订单ID、支付状态、交易号）
- ✅ Gemini API调用（成功/失败、耗时）
- ✅ 错误日志（堆栈信息、上下文）

---

**影响文件**
- 所有部署配置文件（`vercel.json`, `railway.toml`等）
- 环境变量配置
- DNS配置

---

## 🏗️ 实施计划

### 阶段1:前端优化(2-3天)

**任务清单**
- [ ] 去掉生成1张的选项(如果有)
- [ ] 新增"四格漫画模式"开关组件
- [ ] 实现四格漫画模式的交互逻辑:
  - [ ] 关闭时:隐藏表情选择,显示"换一换"按钮
  - [ ] 开启时:显示表情选择(单选),隐藏"换一换"按钮
- [ ] 实现随机表情抽取逻辑(普通模式)
- [ ] 新增支付流程UI:
  - [ ] 支付页面/弹窗(显示二维码)
  - [ ] 支付成功提示
  - [ ] 支付失败/取消提示
  - [ ] 支付轮询逻辑
- [ ] 调整生成按钮显示价格

**关键文件**
- `App.tsx`
- `components/StickerGrid.tsx`
- `constants.ts`(新增随机抽取函数)

---

### 阶段2:后端搭建(3-4天)

**任务清单**
- [ ] 初始化Node.js + Express项目
- [ ] 配置TypeScript环境
- [ ] 集成Redis客户端(Upstash免费版 或 本地Redis)
- [ ] 实现用户识别中间件(IP + Device ID)
- [ ] 实现Gemini API代理服务(`gemini.ts`)
- [ ] 实现支付服务(`payment.ts`):
  - [ ] 创建订单
  - [ ] 验证支付状态
  - [ ] 支付回调处理
  - [ ] Token验证
- [ ] 实现API路由:
  - [ ] `POST /api/analyze-character`
  - [ ] `POST /api/generate-sticker-grid`
  - [ ] `POST /api/payment/create`
  - [ ] `GET /api/payment/verify`
  - [ ] `POST /api/payment/callback`(微信/支付宝回调)
- [ ] 集成微信支付SDK(推荐)
- [ ] 编写错误处理和日志记录
- [ ] 本地测试

**技术选型**
- **Redis**:推荐使用 [Upstash](https://upstash.com/)(免费额度10,000请求/天)
- **部署**:推荐使用 [Railway](https://railway.app/) 或 [Render](https://render.com/)(免费额度足够初期使用)
- **支付SDK**:
  - 微信支付:[wechatpay-node-v3](https://github.com/wechatpay-apiv3/wechatpay-node-v3)
  - 支付宝:[alipay-sdk](https://github.com/alipay/alipay-sdk-nodejs-all)

---

### 阶段3:前后端联调(2天)

**任务清单**
- [ ] 前端移除直接调用Gemini API的代码
- [ ] 前端改为调用后端API(`/api/*`)
- [ ] 集成支付流程:
  - [ ] 创建订单并显示支付页面
  - [ ] 轮询支付状态
  - [ ] 支付成功后自动开始生成
  - [ ] 携带paymentToken调用生成API
- [ ] 测试完整流程:
  - [ ] 普通模式生成(随机表情)
  - [ ] 四格漫画模式生成(连续动作)
  - [ ] 支付流程(创建订单→支付→验证→生成)
  - [ ] 支付失败/取消的处理
  - [ ] Token验证(防止未支付生成)

---

### 阶段4:支付平台对接(2-3天)

**任务清单**
- [ ] 注册微信支付商户号
- [ ] 配置支付回调URL
- [ ] 测试微信支付Native扫码支付(PC端)
- [ ] 测试微信支付JSAPI支付(移动端)
- [ ] (可选)集成支付宝扫码支付
- [ ] 测试支付回调处理
- [ ] 测试订单过期自动取消

---

### 阶段5:域名配置与部署发布(2-3天)

**任务清单**

**域名&Cloudflare配置**
- [ ] 将域名添加到Cloudflare
- [ ] 更新域名NS记录到Cloudflare
- [ ] 配置DNS记录(sticker子域名、api子域名)
- [ ] 配置SSL/TLS加密模式(完全严格)
- [ ] 开启"始终使用HTTPS"
- [ ] 配置页面规则(前端静态资源缓存、API不缓存)
- [ ] 配置WAF防火墙规则(API速率限制)

**前端部署(Vercel)**
- [ ] 安装Vercel CLI并登录
- [ ] 部署前端项目(`vercel --prod`)
- [ ] 在Vercel添加自定义域名(`sticker.example.com`)
- [ ] 在Cloudflare添加CNAME记录指向Vercel
- [ ] 配置环境变量(`VITE_API_URL`等)
- [ ] 验证前端域名可访问且SSL有效

**后端部署(Railway)**
- [ ] 安装Railway CLI并登录
- [ ] 初始化后端项目(`railway init`)
- [ ] 添加Redis服务
- [ ] 配置环境变量(API Key、Redis URL、支付密钥等)
- [ ] 部署后端项目(`railway up`)
- [ ] 在Railway添加自定义域名(`api.example.com`)
- [ ] 在Cloudflare添加CNAME记录指向Railway
- [ ] 验证后端域名可访问且SSL有效

**支付平台配置**
- [ ] 在微信支付商户平台设置回调URL
- [ ] 在支付宝开放平台设置通知URL
- [ ] 测试支付回调URL可公网访问

**部署验证测试**
- [ ] 前端检查(域名访问、SSL证书、资源加载)
- [ ] 后端检查(API响应、CORS、Redis连接)
- [ ] 域名&SSL检查(DNS解析、证书有效期)
- [ ] 支付功能检查(订单创建、支付回调)
- [ ] 性能&安全检查(缓存规则、速率限制)
- [ ] 端到端测试:
  - [ ] 测试不同设备的订单隔离
  - [ ] 测试支付成功后的生成流程
  - [ ] 测试支付失败的处理
  - [ ] 测试Redis连接稳定性
- [ ] 性能测试(并发请求、响应时间)
- [ ] 安全测试(防止Token伪造、重放攻击等)

---

### 阶段6:文档与优化(1天)

**任务清单**
- [ ] 编写后端API文档(Swagger / Postman)
- [ ] 编写支付对接文档
- [ ] 编写部署文档(环境变量配置、部署步骤)
- [ ] 优化代码注释
- [ ] 代码Review
- [ ] 准备v2.0发布说明

---

## 📊 技术架构对比

### v1.0(当前)

```
前端 (React)
    ↓
Gemini API (直接调用)
    ↓
生成表情包
```

**优势**:简单快速,无需后端
**劣势**:API密钥暴露在前端,无法实现付费功能

---

### v2.0(目标)

```
前端 (React)
    ↓
后端 API (Express + Redis)
    ├─ 用户识别(IP + Device ID / OpenID)
    ├─ 支付管理(微信支付/支付宝)
    └─ Gemini API代理(隐藏密钥)
    ↓
Gemini AI
    ↓
生成表情包
```

**优势**:
- ✅ API密钥安全(隐藏在后端)
- ✅ 支持付费功能(按次计费)
- ✅ 更好的错误处理和日志记录
- ✅ 用户行为可统计(订单、收入等)

**劣势**:
- ⚠️ 增加了后端复杂度
- ⚠️ 需要部署和维护后端服务
- ⚠️ 需要对接支付平台

---

## 🔒 安全与隐私

### API密钥保护
- ❌ 不再在前端暴露Gemini API Key
- ✅ 后端通过环境变量管理API Key
- ✅ 前端仅发送必要参数(图片、提示词等)

### 支付安全
- ✅ 后端验证支付回调签名(防止伪造)
- ✅ paymentToken一次性使用(防止重放攻击)
- ✅ 订单15分钟过期自动取消
- ✅ 前端不可绕过支付验证

### 用户隐私
- ✅ 不收集用户个人信息(除非用户主动登录)
- ✅ IP地址仅用于用户识别,不用于其他用途
- ✅ 上传的图片仅用于生成表情包,不存储在服务器

### 速率限制
- ✅ 后端实现速率限制(防止恶意请求)
- ✅ 单IP每分钟最多10次生成请求
- ✅ 单IP每分钟最多5次创建订单

---

## 💰 定价策略

### 按次付费(v2.0)

| 生成张数 | 价格 | 适用场景 |
|---------|------|----------|
| 4张 | ¥1.00 | 快速生成少量表情 |
| 8张 | ¥2.00 | 中等规模表情包 |
| 12张 | ¥3.00 | 完整表情包套装 |

**定价优势**:
- ✅ 低门槛:最低¥1即可体验
- ✅ 按需付费:用多少付多少,无浪费
- ✅ 价格透明:无隐藏费用

**未来扩展(v2.1+)**:
- 会员制:¥9.9/月无限生成(更高频用户)
- 批量优惠:一次生成24张¥5(原价¥6)
- 企业版:定制风格、API接口、技术支持

---

## ✅ 验收标准

### 功能验收
- [ ] 生成张数仅显示4/8/12张选项
- [ ] 四格漫画模式开关正常工作
- [ ] 普通模式下,表情选择区域隐藏,显示"换一换"按钮
- [ ] 四格漫画模式下,显示表情选择(单选),生成连续动作
- [ ] 支付流程完整:
  - [ ] 点击"开始生成"跳转支付页面
  - [ ] 显示支付二维码
  - [ ] 支付成功后自动开始生成
  - [ ] 支付失败/取消的错误提示
- [ ] 后端API正常响应(响应时间<3秒)
- [ ] paymentToken验证正常(未支付无法生成)

### 性能验收
- [ ] 前端首屏加载时间 < 2秒
- [ ] 后端API响应时间 < 3秒
- [ ] 并发10个用户同时生成,不出现错误
- [ ] 支付回调处理时间 < 1秒

### UI验收
- [ ] 新增组件与现有风格一致
- [ ] 移动端适配良好(响应式布局)
- [ ] 无UI错位、重叠等问题
- [ ] 支付页面显示清晰(二维码、金额、订单号)

### 安全验收
- [ ] API密钥不暴露在前端
- [ ] 支付回调签名验证正常
- [ ] paymentToken无法伪造或重复使用
- [ ] 速率限制正常工作(防止恶意刷接口)
- [ ] 订单过期自动取消

---

## 🐛 风险与应对

### 风险1:Gemini API不稳定
**应对**:
- 实现重试机制(已有,继续优化)
- 增加错误提示,引导用户稍后重试
- 支付失败自动退款(避免扣费但未生成)

### 风险2:Redis服务挂掉
**应对**:
- 使用可靠的Redis服务商(Upstash、Railway、Render自带)
- 实现降级策略:Redis不可用时,暂停接单(返回"系统维护中")

### 风险3:支付回调延迟/丢失
**应对**:
- 前端轮询支付状态(每2秒查询,最多60秒)
- 后端记录支付日志,人工补单
- 支持用户主动查询订单状态

### 风险4:用户恶意创建大量订单
**应对**:
- 单IP每分钟最多5次创建订单
- 订单15分钟过期自动取消
- 监控异常行为(如短时间大量创建),封禁IP

---

## 📞 后续支持

### 技术支持
- **开发者**:[您的联系方式]
- **文档**:[项目Wiki/Notion链接]

### 迭代计划
- **v2.1**:新增更多风格和人物分类
- **v2.2**:微信小程序端开发
- **v2.3**:会员制(¥9.9/月无限生成)
- **v3.0**:AI自动优化生成效果,支持视频表情包

---

## 📝 附录

### A. 四格漫画Prompt生成示例

```typescript
// 连续动作分解的Prompt生成函数
function generateComicStages(emotion: string): string[] {
  const templates: Record<string, string[]> = {
    微笑: [
      "准备微笑，嘴角微微上扬，眼神温柔",
      "开始微笑，露出洁白的牙齿，眼睛微微眯起",
      "微笑高峰，笑容最灿烂，眼睛弯成月牙，脸颊微红",
      "微笑结束，恢复平静，嘴角仍带笑意，眼神满足"
    ],

    吃火锅: [
      "看到火锅，眼睛发光，表情兴奋期待",
      "拿起筷子，开心地夹起食材",
      "大口吃火锅，满足的表情，眼睛眯起",
      "吃完后满足地摸摸肚子，心满意足"
    ],

    大哭: [
      "眼眶湿润，开始委屈",
      "眼泪开始流下，表情难过",
      "大声哭泣，泪流满面",
      "哭累了，抽泣着擦眼泪"
    ],

    加班: [
      "看到加班通知，表情震惊",
      "无奈打开电脑，叹气",
      "疲惫工作，打哈欠",
      "终于下班，松了一口气"
    ]
  };

  return templates[emotion] || [
    `${emotion} - 准备阶段`,
    `${emotion} - 进行中`,
    `${emotion} - 高峰阶段`,
    `${emotion} - 结束阶段`
  ];
}
```

### B. 随机表情抽取逻辑

```typescript
// 从表情库中随机抽取指定数量的表情
function randomSample(emotions: string[], count: number): string[] {
  const shuffled = [...emotions].sort(() => Math.random() - 0.5);
  return shuffled.slice(0, count);
}

// 示例
const femaleEmotions = EMOTIONS.female; // 50个女性表情
const randomPrompts = randomSample(femaleEmotions, 4);
// 返回: ["喝奶茶", "减肥失败", "买买买", "化妆"]
```

### C. 支付流程时序图

```
用户                前端                后端                支付平台
 │                   │                   │                   │
 │ 点击"开始生成"   │                   │                   │
 ├──────────────────>│                   │                   │
 │                   │ POST /api/payment/create            │
 │                   ├──────────────────>│                   │
 │                   │                   │ 生成订单&Token    │
 │                   │<──────────────────┤                   │
 │                   │ 返回支付URL       │                   │
 │<──────────────────┤                   │                   │
 │ 显示支付二维码    │                   │                   │
 │                   │                   │                   │
 │ 扫码支付          │                   │                   │
 ├───────────────────────────────────────────────────────────>│
 │                   │                   │<──────────────────┤
 │                   │                   │ 支付回调(webhook) │
 │                   │                   │ 更新订单状态      │
 │                   │                   │                   │
 │                   │ GET /api/payment/verify (轮询)       │
 │                   ├──────────────────>│                   │
 │                   │<──────────────────┤                   │
 │                   │ 返回status=paid   │                   │
 │                   │                   │                   │
 │                   │ POST /api/generate-sticker-grid      │
 │                   │ Headers: X-Payment-Token             │
 │                   ├──────────────────>│                   │
 │                   │                   │ 验证Token         │
 │                   │                   │ 调用Gemini API    │
 │                   │<──────────────────┤                   │
 │                   │ 返回表情包        │                   │
 │<──────────────────┤                   │                   │
 │ 展示表情包        │                   │                   │
```

### D. Redis数据结构详细设计

```typescript
// 订单数据结构
interface PaymentOrder {
  orderId: string;          // 订单ID: "order_" + UUID
  userId: string;           // 用户ID: IP + Device ID
  count: number;            // 生成张数: 4/8/12
  amount: number;           // 金额(元): 1/2/3
  status: "pending" | "paid" | "expired" | "cancelled";
  paymentToken: string;     // 支付凭证(UUID)
  paymentMethod?: "wechat" | "alipay";  // 支付方式
  transactionId?: string;   // 支付平台交易号
  createdAt: string;        // 创建时间(ISO格式)
  paidAt?: string;          // 支付时间
  expiresAt: string;        // 过期时间(创建时间+15分钟)
}

// Redis存储
// Key: payment:{orderId}
// Value: JSON.stringify(PaymentOrder)
// TTL: 1小时(订单过期后1小时删除)

// 示例
redis.set(
  "payment:order_12345",
  JSON.stringify({
    orderId: "order_12345",
    userId: "192.168.1.1_abc123",
    count: 4,
    amount: 1.00,
    status: "paid",
    paymentToken: "token_abc123",
    paymentMethod: "wechat",
    transactionId: "wx_4200001234567890",
    createdAt: "2025-12-16T10:30:00Z",
    paidAt: "2025-12-16T10:32:15Z",
    expiresAt: "2025-12-16T10:45:00Z"
  }),
  "EX",
  3600  // 1小时过期
);
```

### E. Cloudflare配置快速参考

**DNS记录配置**
```
# 前端域名
类型: CNAME
名称: sticker
内容: cname.vercel-dns.com
代理: 已代理(橙色云)
TTL: Auto

# 后端域名
类型: CNAME
名称: api
内容: your-app.up.railway.app
代理: 已代理(橙色云)
TTL: Auto
```

**SSL/TLS设置**
```
加密模式: 完全(严格)
始终使用HTTPS: 开启
自动HTTPS重写: 开启
最低TLS版本: TLS 1.2
```

**页面规则**
```
规则1: sticker.example.com/assets/*
  - 缓存级别: 缓存所有内容
  - 边缘缓存TTL: 1个月

规则2: api.example.com/*
  - 缓存级别: 绕过
```

**WAF规则**
```
规则1: 限制API请求
  - 主机名 = api.example.com
  - 速率限制: 100次/分钟(按IP)

规则2: 阻止恶意爬虫
  - User-Agent 包含 bot|crawler|scraper
  - 操作: 阻止
```

### F. 环境变量配置清单

**前端环境变量(Vercel)**
```env
# API配置
VITE_API_URL=https://api.example.com

# 支付回调配置
VITE_PAYMENT_CALLBACK_URL=https://sticker.example.com/payment/callback

# 开发环境配置(可选)
VITE_DEV_MODE=false
```

**后端环境变量(Railway)**
```env
# 服务器配置
NODE_ENV=production
PORT=8080

# Gemini API
GEMINI_API_KEY=your_gemini_api_key_here

# Redis
REDIS_URL=redis://default:password@redis-host:6379

# CORS配置
ALLOWED_ORIGINS=https://sticker.example.com

# 微信支付
WECHAT_PAY_MERCHANT_ID=1234567890
WECHAT_PAY_API_KEY=your_wechat_api_key
WECHAT_PAY_CERT_PATH=/app/certs/wechat_pay_cert.pem

# 支付宝(可选)
ALIPAY_APP_ID=2021001234567890
ALIPAY_PRIVATE_KEY=your_alipay_private_key
ALIPAY_PUBLIC_KEY=alipay_public_key

# 支付回调URL
PAYMENT_CALLBACK_URL=https://api.example.com/api/payment/callback

# 日志级别
LOG_LEVEL=info
```

---

## 🎉 总结

本次迭代(v2.0)将为表情包生成器带来以下核心提升:

1. **更灵活的生成模式**:四格漫画模式让表情包更有故事性和连贯性
2. **更简洁的用户体验**:普通模式随机展示,减少用户选择负担
3. **商业化落地**:按次付费系统,实现盈利模式
4. **更高的安全性**:API密钥隐藏在后端,用户数据安全可控

预计开发周期:**12-16天**
技术风险:**中**
商业价值:**高**

**时间分配**：
- 阶段1: 前端优化 (2-3天)
- 阶段2: 后端搭建 (3-4天)
- 阶段3: 前后端联调 (2天)
- 阶段4: 支付平台对接 (2-3天)
- 阶段5: 域名配置与部署发布 (2-3天)
- 阶段6: 文档与优化 (1天)

---

**文档版本**:v2.0
**最后更新**:2025-12-16
**作者**:Claude Code
**审核状态**:待用户确认
